from fastapi import FastAPI


import uvicorn
from os import getenv

from src.utils.Logger import Logger 
from src.bot.Bot import Bot
from src.messages.BotMessages import BotMessages


def main(app: FastAPI):
    logger = Logger()
    logger.info('—Å–µ—Ä–≤–µ—Ä FastAPI –≤–∫–ª—é—á—ë–Ω üëÄ')

    #? –¢—É—Ç –±—É–¥–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–ª–µ–¥—É—é—â–∏–π –ø–æ—Ä—è–¥–æ–∫:
    #? 1) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è Mongo, –≤–Ω–æ—Å–∏—Ç –≤ –ë–î –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ, —Ç.–∫. —Ç–∞–º —É–∂–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏). –ö–∞–∂–µ—Ç—Å—è, insert_one –Ω–µ –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å —ç—Ç–æ, –µ—Å–ª–∏ —é–∑–µ—Ä —É–∂–µ –µ—Å—Ç—å –≤ –ë–î. –ï—Å–ª–∏ –∂–µ –Ω–µ—Ç, –¥–µ–ª–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É is_user_exists()
    #? 2) –ó–∞—Ç–µ–º –∫–µ—à–∏—Ä—É–µ–º –≤—Å–µ—Ö —é–∑–µ—Ä–æ–≤ —Ç—É—Ç (–ø–æ –ª—é–±–æ–º—É –¥–µ–ª–∞–µ–º —ç—Ç–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ). –ö–ª–∞—Å—Å CachedUsers, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —é–∑–µ—Ä—ã (–Ω–æ –≤ –∫–µ—à–µ –º–æ–∂–µ—Ç –∂–∏—Ç—å –∫—É–¥–∞ –±–æ–ª—å—à–µ)
    #? 3) –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –µ—Å—Ç—å —Å–º—ã—Å–ª –∑–∞–ø—É—Å–∫–∞—Ç—å –±–æ—Ç–∞ –∏ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ
    
    #? 1) –°–æ—Ö—Ä–∞–Ω—è–µ–º —é–∑–µ—Ä–æ–≤ –≤ –ë–î
    #? 2) –ö–µ—à–∏—Ä—É–µ–º –∏—Ö
    #? 3) –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ —Å —ç—Ç–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–∫–µ—à –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö, —ç—Ç–æ –≤–∞–∂–Ω–æ). –í–µ—Ä–æ—è—Ç–Ω–æ, —Ç—É—Ç –µ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –Ω–µ –±—É–¥–µ—Ç –∏–ª–∏ –∂–µ –æ–Ω –ø—Ä–æ—Å—Ç–æ –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ç—Å—è –∏–∑ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ —Ä–∞–∑–Ω—ã–µ –º–µ—Å—Ç–∞ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å circular import)


    # set commands and message handlers
    school_bot = Bot()
    BotMessages(school_bot)
    school_bot.start_bot()
    
    school_bot.disconnect_bot()
    logger.info('—Å–µ—Ä–≤–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω ‚ùå')
    

app = FastAPI(lifespan=main)


if __name__ == "__main__":
    PORT = int(getenv("PORT", 8000))
    uvicorn.run(app, host="0.0.0.0", port=PORT)
